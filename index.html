<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sora视频去水印工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .url-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }
        
        .parse-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-section {
            display: none;
        }
        
        .video-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .video-player {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #000;
            border-radius: 8px;
            margin: 0 auto 20px;
        }
        
        .video-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        
        .cover-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .title-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .success {
            color: #27ae60;
            background: #eafaf1;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        /* 结果区域两栏布局 */
        .results-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }
        .left-pane .action-buttons {
            justify-content: flex-start;
        }
        .info-card h3 {
            margin-bottom: 8px;
        }
        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            .video-player {
                width: 100%;
                height: auto;
                aspect-ratio: 3 / 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 视频去水印工具</h1>
            <p>快速解析并下载无水印视频</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="url-input-group">
                    <input type="text" id="videoUrl" class="url-input" placeholder="请输入视频链接地址...">
                    <button class="btn btn-primary" onclick="pasteFromClipboard()">📋 粘贴</button>
                </div>
                
                <div class="parse-buttons">
                    <button class="btn btn-success" onclick="parseVideo('highSpeed')">🚀 高速解析</button>
                    <button class="btn btn-warning" onclick="parseVideo('original')">📹 原地址解析</button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在解析视频，请稍候...</p>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>

            
            <div class="result-section" id="resultSection">
                <div class="video-container">
                    <div class="results-grid">
                        <div class="left-pane">
                            <h3 style="margin-bottom:10px;">无水印视频</h3>
                            <video id="videoPlayer" class="video-player" controls>
                                您的浏览器不支持视频播放
                            </video>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="downloadVideo()">⬇️ 下载视频</button>
                            </div>
                        </div>
                        <div class="right-pane">
                            <div class="info-card">
                                <h3>📝 视频标题</h3>
                                <textarea id="videoTitle" class="title-input" rows="5" readonly></textarea>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="copyTitle()">📋 复制标题</button>
                                </div>
                            </div>
                            <div class="info-card">
                                <h3>🖼️ 视频封面</h3>
                                <img id="coverImage" class="cover-image" alt="视频封面">
                                <div class="action-buttons">
                                    <button class="btn btn-success" onclick="downloadCover()">⬇️ 下载封面</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 解析接口配置
        const API_ENDPOINTS = {
            highSpeed: 'https://api.yuantoai.com/api/dsp/替换/202036993/?url=',
            original: 'https://api.yuantoai.com/api/dsp/替换/202036993/?url='
        };
        // 可选代理配置：部署好你的反向代理后，开启 USE_PROXY 并设置 PROXY_PREFIX
        const USE_PROXY = false; // 部署代理后改为 true
        const PROXY_PREFIX = 'https://your-worker.your-subdomain.workers.dev/?url='; // 例如 Cloudflare Worker 地址
        
        // 显示消息
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            element.className = isError ? 'error' : 'success';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
        
        // 从剪贴板粘贴
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('videoUrl').value = text;
                showMessage('successMessage', '粘贴成功！');
            } catch (error) {
                showMessage('errorMessage', '粘贴失败，请手动输入链接', true);
            }
        }
        
        // 解析视频
        async function parseVideo(type) {
            const videoUrl = document.getElementById('videoUrl').value.trim();
            
            if (!videoUrl) {
                showMessage('errorMessage', '请输入视频链接地址', true);
                return;
            }
            
            // 显示加载中/隐藏旧内容
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';

            
            try {
                const apiUrl = API_ENDPOINTS[type] + encodeURIComponent(videoUrl);
                const requestUrl = USE_PROXY ? (PROXY_PREFIX + encodeURIComponent(apiUrl)) : apiUrl;
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        // 可按需添加：'Referer': location.origin
                    },
                    cache: 'no-cache',
                    credentials: 'omit'
                });
                
                // 先尝试解析为 JSON；若失败，捕获并给出更明确提示
                let data;
                try {
                    data = await response.json();
                } catch (jsonErr) {
                    throw new Error(`响应不是有效JSON，可能是CORS或服务端异常（HTTP ${response.status}）`);
                }
                

                
                if (!response.ok) {
                    // 优先显示服务端返回的 msg
                    const serverMsg = (data && (data.msg || data.message)) ? `；服务端提示：${data.msg || data.message}` : '';
                    throw new Error(`HTTP错误: ${response.status}${serverMsg}`);
                }
                
                // 业务判断
                if (data && data.code === 200 && data.data) {
                    displayResults(data.data);
                    // 显示服务端返回消息或默认成功
                    showMessage('successMessage', data.msg || '解析成功！');
                } else {
                    const serverMsg = (data && (data.msg || data.message)) ? data.msg || data.message : '解析失败';
                    throw new Error(serverMsg);
                }
            } catch (error) {
                // 针对常见网络错误进行友好提示
                const msg = (error && error.message) ? error.message : '未知错误';
                const isNetworkError = /Failed to fetch|NetworkError|TypeError/i.test(msg);
                const friendly = isNetworkError ? '网络或跨域错误（CORS），请稍后重试或联系接口服务商开启跨域' : msg;
                showMessage('errorMessage', `解析失败: ${friendly}`, true);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // 选择无水印与播放地址
        function resolveVideoUrls(data) {
            const first = (arr) => arr.find(u => typeof u === 'string' && u.trim());
            // 扩展无水印候选字段集合
            const candidatesNoWM = [
                data && data.down,
                data && data.download,
                data && data.down_url,
                data && data.nwm_url,
                data && data.no_watermark,
                data && data.noWatermark,
                data && data.url_no_wm,
                data && data.url_no_watermark,
                data && data.play_url_no_wm,
                data && data.nwm,
                data && data.nwmLink,
                data && data.no_wm,
                data && data.noWm
            ];
            const candidatesPlay = [
                data && data.url,
                data && data.play,
                data && data.play_url,
                data && data.video,
                data && data.src,
                data && data.wm_url,
                data && data.watermark
            ];
            // 下载地址严格只取“无水印集合”，不再回退播放地址
            const downloadUrl = first(candidatesNoWM) || '';
            // 播放器优先用播放地址，若没有再用无水印（个别源无播放直链）
            const playUrl = first(candidatesPlay) || downloadUrl || '';
            return { playUrl, downloadUrl };
        }

        // 显示解析结果
        function displayResults(data) {
            const resultSection = document.getElementById('resultSection');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoTitle = document.getElementById('videoTitle');
            const coverImage = document.getElementById('coverImage');
            
            // 设置视频播放器与下载直链（优先无水印）
            const { playUrl, downloadUrl } = resolveVideoUrls(data);
            videoPlayer.src = playUrl;
            videoPlayer.dataset.download = downloadUrl || '';
            videoPlayer.load();
            
            // 设置视频标题
            videoTitle.value = data.title || '无标题';
            
            // 设置封面图片
            coverImage.src = data.photo || data.cover || data.download_image;
            coverImage.alt = data.title || '视频封面';
            
            // 显示结果区域
            resultSection.style.display = 'block';
        }
        
        // 复制标题
        function copyTitle() {
            const titleInput = document.getElementById('videoTitle');
            titleInput.select();
            titleInput.setSelectionRange(0, titleInput.value.length);
            
            try {
                navigator.clipboard.writeText(titleInput.value);
                showMessage('successMessage', '标题已复制到剪贴板！');
            } catch (error) {
                showMessage('errorMessage', '复制失败，请手动复制', true);
            }
        }
        
        // 通用下载：优先以 Blob 方式保存，失败时回退为直链打开
        async function downloadFile(url, filenameBase, defaultExt) {
            if (!url) {
                showMessage('errorMessage', '下载链接为空', true);
                return;
            }
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    cache: 'no-cache'
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const blob = await res.blob();
                // 根据 Content-Type 或 URL 猜测扩展名
                const ct = (res.headers.get('Content-Type') || '').toLowerCase();
                let ext = defaultExt;
                if (ct.includes('mp4') || ct.includes('mpeg')) ext = '.mp4';
                else if (ct.includes('webm')) ext = '.webm';
                else if (ct.includes('jpeg') || ct.includes('jpg')) ext = '.jpg';
                else if (ct.includes('png')) ext = '.png';
                else if (ct.includes('gif')) ext = '.gif';
                else {
                    // 从 URL 尝试提取扩展
                    const m = url.split('?')[0].match(/\.([a-z0-9]+)$/i);
                    if (m && m[1]) ext = '.' + m[1].toLowerCase();
                }
                const objectUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = objectUrl;
                a.download = filenameBase + ext;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(objectUrl);
                showMessage('successMessage', '开始下载...');
            } catch (e) {
                // 回退：直链打开并提示（与“下载逻辑.txt”一致）
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener';
                a.download = filenameBase + defaultExt;
                document.body.appendChild(a);
                a.click();
                a.remove();
                showMessage('successMessage', '已尝试通过直链下载/打开');
            }
        }

        // 下载视频（按“下载逻辑.txt”）
        function downloadVideo() {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoUrl = videoPlayer.src;
            const rawTitle = document.getElementById('videoTitle').value || 'video';
            const safeTitle = rawTitle.trim().replace(/[\\/:*?"<>|]+/g, '_').slice(0, 80);
            if (videoUrl && videoUrl !== '') {
                downloadFile(videoUrl, safeTitle || 'video', '.mp4');
            } else {
                showMessage('errorMessage', '无法获取视频下载链接', true);
            }
        }

        // 下载封面（按“下载逻辑.txt”）
        function downloadCover() {
            const coverImage = document.getElementById('coverImage');
            const coverUrl = coverImage.src;
            const rawTitle = document.getElementById('videoTitle').value || 'cover';
            const safeTitle = rawTitle.trim().replace(/[\\/:*?"<>|]+/g, '_').slice(0, 80);
            if (coverUrl && coverUrl !== '') {
                downloadFile(coverUrl, (safeTitle || 'cover') + '-cover', '.jpg');
            } else {
                showMessage('errorMessage', '无法获取封面下载链接', true);
            }
        }
        
        // 输入框回车事件
        document.getElementById('videoUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                parseVideo('highSpeed');
            }
        });
    </script>
</body>

</html>
